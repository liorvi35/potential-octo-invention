<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chessboard Classification</title>
	<link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
      :root {
        --bg: #0b1020;
        --card: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.12);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.66);
        --bad: #ff6b6b;
        --ok: #7ee787;
        --btn: rgba(255, 255, 255, 0.12);
        --btnHover: rgba(255, 255, 255, 0.18);
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color: var(--text);
        background: radial-gradient(1200px 800px at 20% 10%, #1a2350 0%, var(--bg) 60%) fixed;
      }

      .wrap { max-width: 980px; margin: 28px auto; padding: 0 16px 40px; }
      h1 { font-size: 1.5rem; margin: 0 0 8px; }
      p { margin: 0 0 16px; color: var(--muted); line-height: 1.5; }

      .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
      @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        backdrop-filter: blur(10px);
      }

      .card h2 {
        font-size: 1.05rem;
        margin: 0 0 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .badge {
        font-size: 0.78rem;
        color: var(--muted);
        border: 1px solid var(--border);
        padding: 4px 8px;
        border-radius: 999px;
        white-space: nowrap;
      }

      input[type="file"] {
        width: 100%;
        padding: 10px;
        background: rgba(255,255,255,0.07);
        border: 1px dashed var(--border);
        border-radius: 12px;
        color: var(--muted);
      }

      .btnrow { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

      button {
        appearance: none;
        border: 1px solid var(--border);
        background: var(--btn);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
      }
      button:hover { background: var(--btnHover); }
      button:disabled { opacity: 0.55; cursor: not-allowed; }

      .status { margin-top: 10px; font-size: 0.95rem; color: var(--muted); white-space: pre-wrap; }
      .status.ok { color: var(--ok); }
      .status.bad { color: var(--bad); }

      .imgbox {
        width: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.2);
        display: grid;
        place-items: center;
        overflow: hidden;
        margin-top: 12px;
      }
      .imgbox img { width: 100%; height: 100%; object-fit: contain; display: none; }
      .placeholder { color: var(--muted); text-align: center; padding: 14px; font-size: 0.95rem; }

      .meta { margin-top: 10px; font-size: 0.9rem; color: var(--muted); display: grid; gap: 6px; }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 0.92em;
        padding: 2px 6px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.06);
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>Chessboard Classification — PNG Upload</h1>
      <p>
        Upload a PNG, preview it, then send it to <code>/boardClassification</code>.
        The response is assumed to be a PNG and is previewed on the right.
      </p>

      <div class="grid">
        <section class="card">
          <h2>Input Image <span class="badge">PNG only</span></h2>
          <input id="fileInput" type="file" accept="image/png" />
          <div class="btnrow">
            <button id="sendBtn" disabled>Send</button>
            <button id="clearBtn" disabled>Clear</button>
          </div>
          <div id="clientStatus" class="status"></div>

          <div class="imgbox">
            <img id="inputPreview" alt="Input PNG preview" />
            <div id="inputPlaceholder" class="placeholder">Choose a PNG file to see a preview here.</div>
          </div>
          <div class="meta" id="inputMeta"></div>
        </section>

        <section class="card">
          <h2>Output Image <span class="badge">PNG response</span></h2>
          <div class="imgbox">
            <img id="outputPreview" alt="Output PNG preview" />
            <div id="outputPlaceholder" class="placeholder">
              The server response (PNG) will appear here after you click <b>Send</b>.
            </div>
          </div>
          <div class="meta" id="outputMeta"></div>
        </section>
      </div>
    </div>

    <script>
      // Fixed backend endpoint (user does not enter a domain).
      // Must be HTTPS because GitHub Pages is HTTPS.
      const ENDPOINT = "https://chess-api-en20.onrender.com:8000/boardClassification"; // <-- change this

      const fileInput = document.getElementById("fileInput");
      const sendBtn = document.getElementById("sendBtn");
      const clearBtn = document.getElementById("clearBtn");
      const clientStatus = document.getElementById("clientStatus");

      const inputPreview = document.getElementById("inputPreview");
      const inputPlaceholder = document.getElementById("inputPlaceholder");
      const inputMeta = document.getElementById("inputMeta");

      const outputPreview = document.getElementById("outputPreview");
      const outputPlaceholder = document.getElementById("outputPlaceholder");
      const outputMeta = document.getElementById("outputMeta");

      let selectedFile = null;
      let inputObjectUrl = null;
      let outputObjectUrl = null;

      const setStatus = (msg, kind = "") => {
        clientStatus.textContent = msg || "";
        clientStatus.className = "status" + (kind ? " " + kind : "");
      };

      const resetOutput = () => {
        outputMeta.textContent = "";
        outputPreview.style.display = "none";
        outputPreview.removeAttribute("src");
        outputPlaceholder.style.display = "block";
        if (outputObjectUrl) URL.revokeObjectURL(outputObjectUrl);
        outputObjectUrl = null;
      };

      const resetInput = () => {
        inputMeta.textContent = "";
        inputPreview.style.display = "none";
        inputPreview.removeAttribute("src");
        inputPlaceholder.style.display = "block";
        if (inputObjectUrl) URL.revokeObjectURL(inputObjectUrl);
        inputObjectUrl = null;
      };

      const clearAll = () => {
        fileInput.value = "";
        selectedFile = null;
        sendBtn.disabled = true;
        clearBtn.disabled = true;
        setStatus("");
        resetInput();
        resetOutput();
      };

      const arrayBufferToBase64 = (buffer) => {
        const bytes = new Uint8Array(buffer);
        let binary = "";
        const chunkSize = 0x8000;
        for (let i = 0; i < bytes.length; i += chunkSize) {
          binary += String.fromCharCode(...bytes.subarray(i, i + chunkSize));
        }
        return btoa(binary);
      };

      const showInputPreview = (file) => {
        resetInput();
        inputObjectUrl = URL.createObjectURL(file);
        inputPreview.src = inputObjectUrl;
        inputPreview.style.display = "block";
        inputPlaceholder.style.display = "none";
        inputMeta.innerHTML = `
          <div><b>Name:</b> ${file.name}</div>
          <div><b>Type:</b> ${file.type || "unknown"}</div>
          <div><b>Size:</b> ${(file.size / 1024).toFixed(1)} KB</div>
        `;
      };

      const showOutputPreviewFromBlob = (blob) => {
        resetOutput();
        outputObjectUrl = URL.createObjectURL(blob);
        outputPreview.src = outputObjectUrl;
        outputPreview.style.display = "block";
        outputPlaceholder.style.display = "none";
        outputMeta.innerHTML = `
          <div><b>Type:</b> ${blob.type || "image/png"}</div>
          <div><b>Size:</b> ${(blob.size / 1024).toFixed(1)} KB</div>
        `;
      };

      fileInput.addEventListener("change", () => {
        setStatus("");
        resetOutput();

        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          selectedFile = null;
          sendBtn.disabled = true;
          clearBtn.disabled = true;
          resetInput();
          return;
        }

        if (file.type !== "image/png" && !file.name.toLowerCase().endsWith(".png")) {
          selectedFile = null;
          sendBtn.disabled = true;
          clearBtn.disabled = false;
          resetInput();
          setStatus("Only PNG files are allowed. Please choose a .png file.", "bad");
          return;
        }

        selectedFile = file;
        sendBtn.disabled = false;
        clearBtn.disabled = false;
        showInputPreview(file);
      });

      clearBtn.addEventListener("click", clearAll);

      sendBtn.addEventListener("click", async () => {
        if (!selectedFile) return;

        setStatus("Uploading…");
        sendBtn.disabled = true;
        clearBtn.disabled = true;

        try {
          const buffer = await selectedFile.arrayBuffer();
          const imageBase64 = arrayBufferToBase64(buffer);

          const payload = { filename: selectedFile.name, contentType: "image/png", imageBase64 };

          const res = await fetch(ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Accept": "image/png, application/json" },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const ct = res.headers.get("content-type") || "";
            let detail = "";
            if (ct.includes("application/json")) {
              const j = await res.json().catch(() => null);
              if (j && (j.detail || j.message || j.error)) detail = String(j.detail || j.message || j.error);
            } else {
              detail = await res.text().catch(() => "");
            }
            throw new Error(`Server error (${res.status}). ${detail}`.trim());
          }

          const blob = await res.blob();
          if (!blob.type.startsWith("image/")) throw new Error(`Unexpected response type: ${blob.type || "unknown"}`);

          showOutputPreviewFromBlob(blob);
          setStatus("Done ✓", "ok");
        } catch (err) {
          resetOutput();
          setStatus(err?.message || String(err), "bad");
        } finally {
          sendBtn.disabled = !selectedFile;
          clearBtn.disabled = !selectedFile ? true : false;
        }
      });

      clearAll();
    </script>
  </body>
</html>
